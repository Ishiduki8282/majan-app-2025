<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ»è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        form { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .player-input { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .player-input label { display: block; margin-bottom: 5px; font-weight: bold; }
        .player-input input[type="text"], .player-input input[type="number"] {
            width: calc(100% - 10px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .settings-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .settings-item input { width: calc(100% - 10px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .results-section { background-color: #e9f7ef; border: 1px solid #d4edda; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .results-section h2 { color: #28a745; }
        .result-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #cfe8d4; }
        .result-item:last-child { border-bottom: none; }
        .result-item .name { font-weight: bold; }
        .result-item .rank { color: #0056b3; }
        .result-item .score { font-weight: bold; color: #dc3545; }
        .records-section { background-color: #f0f8ff; border: 1px solid #d1ecf1; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .records-section h2 { color: #17a2b8; }
        .record-entry { margin-bottom: 15px; padding: 10px; border: 1px solid #bee5eb; border-radius: 5px; background-color: #fff; }
        .record-entry h3 { margin-top: 0; color: #17a2b8; font-size: 1.1em; }
        .record-player-data { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #e0f0f3; }
        .record-player-data:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <h1>ğŸ€„ éº»é›€ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ»è¨˜éŒ²ã‚¢ãƒ—ãƒª ğŸ€„</h1>

    <form method="POST">
        <h2>ã‚¹ã‚³ã‚¢å…¥åŠ›</h2>
        {% for i in range(1, 5) %}
        <div class="player-input">
            <label for="player{{ i }}_name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼{{ i }} å:</label>
            <input type="text" id="player{{ i }}_name" name="player{{ i }}_name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼{{ i }}" required>
            <label for="player{{ i }}_points">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼{{ i }} å’Œäº†ç‚¹ (æŒã¡ç‚¹25000ã‹ã‚‰ã®å¢—æ¸›):</label>
            <input type="number" id="player{{ i }}_points" name="player{{ i }}_points" value="0" step="100">
        </div>
        {% endfor %}

        <h2>è¨­å®š</h2>
        <div class="settings-grid">
            <div class="settings-item">
                <label for="uma_1">ã‚¦ãƒ 1ä½:</label>
                <input type="number" id="uma_1" name="uma_1" value="{{ settings.uma_1 if settings else 20 }}" step="1">
            </div>
            <div class="settings-item">
                <label for="uma_2">ã‚¦ãƒ 2ä½:</label>
                <input type="number" id="uma_2" name="uma_2" value="{{ settings.uma_2 if settings else 10 }}" step="1">
            </div>
            <div class="settings-item">
                <label for="uma_3">ã‚¦ãƒ 3ä½:</label>
                <input type="number" id="uma_3" name="uma_3" value="{{ settings.uma_3 if settings else -10 }}" step="1">
            </div>
            <div class="settings-item">
                <label for="uma_4">ã‚¦ãƒ 4ä½:</label>
                <input type="number" id="uma_4" name="uma_4" value="{{ settings.uma_4 if settings else -20 }}" step="1">
            </div>
            <div class="settings-item">
                <label for="oka">ã‚ªã‚« (1ä½ã«åŠ ç®—):</label>
                <input type="number" id="oka" name="oka" value="{{ settings.oka if settings else 25 }}" step="1">
            </div>
            <div class="settings-item">
                <label for="rate">ãƒ¬ãƒ¼ãƒˆ (1.0 = 1000ç‚¹1å††):</label>
                <input type="number" id="rate" name="rate" value="{{ settings.rate if settings else 1.0 }}" step="0.1">
            </div>
        </div>
        <button type="submit">ã‚¹ã‚³ã‚¢è¨ˆç®—</button>
    </form>

    {% if results %}
    <div class="results-section">
        <h2>è¨ˆç®—çµæœ</h2>
        {% for player_result in results %}
        <div class="result-item">
            <span class="name">{{ player_result.name }}</span>
            <span class="rank">{{ player_result.rank }}ä½</span>
            <span class="score">{{ '%+d' % player_result.score }}</span>
        </div>
        {% endfor %}
        <button onclick="saveCurrentRecord()">ã“ã®ã‚²ãƒ¼ãƒ ã‚’è¨˜éŒ²ã™ã‚‹</button>
    </div>
    {% endif %}

    <div class="records-section">
        <h2>éå»ã®è¨˜éŒ²</h2>
        {% if records %}
            {% for date, games_on_date in records.items() %}
                <h3>{{ date }} ã®è¨˜éŒ²</h3>
                {% for game in games_on_date %}
                    <div class="record-entry">
                        {% for name, score in game.playerScores.items() %}
                            <div class="record-player-data">
                                <span>{{ name }}</span>
                                <span>{{ '%+d' % (score * 10) }} ({{ game.playerRanks[name] }}ä½)</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        {% else %}
            <p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>

    <script>
        function saveCurrentRecord() {
            // ç¾åœ¨ã®çµæœãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const results = JSON.parse('{{ results | tojson }}'); // Flaskã®Jinja2ã§Pythonã®å¤‰æ•°ã‚’JavaScriptã«æ¸¡ã™

            if (!results) {
                alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚+1
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            const playerScores = {};
            const playerRanks = {};

            results.forEach(p => {
                playerScores[p.name] = p.score / 10; // è¨˜éŒ²ã¯å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã®å½¢ã«æˆ»ã™
                playerRanks[p.name] = p.rank;
            });

            const recordData = {
                date: formattedDate,
                playerScores: playerScores,
                playerRanks: playerRanks
            };

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/save_record';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'record_data';
            input.value = JSON.stringify(recordData);
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
        }
    </script>
</body>
</html>